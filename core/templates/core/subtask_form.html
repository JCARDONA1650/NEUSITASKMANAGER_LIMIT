{% extends "base.html" %}
{% load static %}
{% load money %}

{% block title %}{% if edit %}Editar Subtarea{% else %}Nueva Subtarea{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/subtask_form.css' %}">
{% endblock %}

{% block content %}
<div class="neu-subtask-page">

  <div class="neu-subtask-head">
    <div>
      <h2 class="neu-subtask-title">
        {% if edit %}Editar Subtarea{% else %}Nueva Subtarea{% endif %}
      </h2>

      {% if task %}
        <div class="neu-subtask-meta">
          <span class="neu-tag"><strong>Tarea:</strong> {{ task.title }}</span>
          <span class="neu-tag"><strong>Proyecto:</strong> {{ task.project.name }}</span>
          <span class="neu-tag"><strong>Presupuesto restante:</strong> {{ task.remaining_budget|cop }}</span>
        </div>
      {% endif %}
    </div>

    <div class="neu-subtask-actions">
      {% if task %}
        <a href="{% url 'task_detail' task.pk %}" class="btn btn-outline-secondary neu-btn-sm">Volver</a>
      {% else %}
        <a href="{% url 'task_list' %}" class="btn btn-outline-secondary neu-btn-sm">Volver</a>
      {% endif %}
    </div>
  </div>

  <!-- =======================
       Datos Subtarea (guardar)
       ======================= -->
  <div class="card neu-card p-3 mb-3">
    <div class="neu-card-title">Datos de la subtarea</div>

    <form method="post" class="neu-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="save">

      <div class="row g-3">
        <div class="col-lg-6">
          <label class="form-label" for="{{ form.title.id_for_label }}">Título</label>
          {{ form.title }}
          {% if form.title.errors %}<div class="neu-err">{{ form.title.errors }}</div>{% endif %}
        </div>

        <div class="col-lg-6">
          <label class="form-label" for="{{ form.story_points.id_for_label }}">Story Points</label>
          {{ form.story_points }}
          {% if form.story_points.errors %}<div class="neu-err">{{ form.story_points.errors }}</div>{% endif %}
        </div>

        <div class="col-12">
          <label class="form-label" for="{{ form.description.id_for_label }}">Descripción</label>
          {{ form.description }}
          {% if form.description.errors %}<div class="neu-err">{{ form.description.errors }}</div>{% endif %}
        </div>

        <div class="col-lg-4">
          <label class="form-label" for="{{ form.budget.id_for_label }}">Presupuesto</label>
          {{ form.budget }}
          {% if form.budget.errors %}<div class="neu-err">{{ form.budget.errors }}</div>{% endif %}
        </div>

        <div class="col-lg-4">
          <label class="form-label" for="{{ form.status.id_for_label }}">Estado</label>
          {{ form.status }}
          {% if form.status.errors %}<div class="neu-err">{{ form.status.errors }}</div>{% endif %}
        </div>

        <div class="col-lg-4">
          <div class="neu-help" style="margin-top: 28px;">
            Los archivos y comentarios se gestionan abajo.
          </div>
        </div>
      </div>

      <div class="neu-form-actions mt-3">
        <button type="submit" class="btn btn-primary">Guardar cambios</button>

        {% if task %}
          <a href="{% url 'task_detail' task.pk %}" class="btn btn-outline-secondary">Volver</a>
        {% else %}
          <a href="{% url 'task_list' %}" class="btn btn-outline-secondary">Volver</a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- =======================
       Archivos (multi-upload)
       ======================= -->
  <div class="card neu-card p-3 mb-3">
    <div class="neu-card-title d-flex justify-content-between align-items-center">
      <span>Archivos</span>
      <span class="neu-pill">Total: {% if attachments %}{{ attachments|length }}{% else %}0{% endif %}</span>
    </div>

    <form method="post" enctype="multipart/form-data" class="neu-form mt-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="upload">

      <div class="row g-3 align-items-end">
        <div class="col-lg-8">
          <label class="form-label">Adjuntar archivos</label>

          {# OJO: el name debe ser "attachments" para request.FILES.getlist("attachments") #}
          <input class="form-control" type="file" name="attachments" multiple>

          {% if files_form %}
            {% if files_form.non_field_errors %}
              <div class="neu-err">{{ files_form.non_field_errors }}</div>
            {% endif %}
            {% if files_form.attachments.errors %}
              <div class="neu-err">{{ files_form.attachments.errors }}</div>
            {% endif %}
          {% endif %}

          <div class="neu-help">
            Puedes subir varios archivos (PDF/imagen/doc/excel). Se aplican límites del plan.
          </div>
        </div>

        <div class="col-lg-4 d-grid">
          <button type="submit" class="btn btn-outline-primary">Subir archivos</button>
        </div>
      </div>
    </form>

    <div class="mt-3">
      {% if attachments %}
        <div class="table-responsive">
          <table class="table neu-table align-middle">
            <thead>
              <tr>
                <th>Archivo</th>
                <th class="text-nowrap">Subido</th>
                <th class="text-nowrap">Por</th>
                <th class="text-end">Acción</th>
              </tr>
            </thead>

            <tbody>
              {% for a in attachments %}
                <tr>
                  <td>
                    <a class="neu-link-inline" href="{{ a.file.url }}" target="_blank" rel="noopener">
                      {{ a.file.name|cut:"attachments/" }}
                    </a>
                  </td>

                  <td class="neu-muted text-nowrap">{{ a.created_at|date:"Y-m-d H:i" }}</td>

                  <td class="neu-muted text-nowrap">
                    {% if a.uploaded_by %}
                      {{ a.uploaded_by.get_full_name|default:a.uploaded_by.username }}
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td class="text-end">
                    {# SIN BORRADO: evita NoReverseMatch. Si creas la view+url, reemplazas esto por el form POST #}
                    <span class="neu-muted">—</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="neu-muted mt-2">No hay archivos cargados.</div>
      {% endif %}
    </div>
  </div>

  <!-- =======================
       Comentarios
       ======================= -->
  <div class="card neu-card p-3">
    <div class="neu-card-title d-flex justify-content-between align-items-center">
      <span>Comentarios</span>
      <span class="neu-pill">Total: {% if comments %}{{ comments|length }}{% else %}0{% endif %}</span>
    </div>

    <form method="post" class="neu-form mt-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="comment">

      <div class="row g-3 align-items-end">
        <div class="col-lg-8">
          <label class="form-label">Nuevo comentario</label>
          {{ comment_form.text }}
          {% if comment_form.text.errors %}<div class="neu-err">{{ comment_form.text.errors }}</div>{% endif %}
        </div>

        <div class="col-lg-4 d-grid">
          <button type="submit" class="btn btn-outline-secondary">Agregar comentario</button>
        </div>
      </div>
    </form>

    <div class="mt-3">
      {% if comments %}
        {% for c in comments %}
          <div class="p-3 mb-2" style="border:1px solid rgba(255,255,255,.12); border-radius:14px; background: rgba(0,0,0,.14);">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <div style="font-weight:800; color:#fff;">
                  {% if c.author %}
                    {{ c.author.get_full_name|default:c.author.username }}
                  {% else %}
                    —
                  {% endif %}
                </div>

                {# ✅ TEXTO BLANCO #}
                <div style="color:#fff; font-weight:700;">{{ c.text|linebreaksbr }}</div>

                <div class="small" style="color:rgba(234,231,242,.80); font-weight:700;">
                  {{ c.created_at|date:"Y-m-d H:i" }}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="neu-muted mt-2">No hay comentarios.</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
